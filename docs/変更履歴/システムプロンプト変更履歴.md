# システムプロンプト変更履歴

## v3 — 2026-02-10

**ファイル:** `backend/src/lib/llm/prompts.ts`, `backend/src/app/design.ts`, `rules/*.yaml`

### 変更概要
テスト種別タグ（`normal` / `semi-normal` / `abnormal`）を導入し、生成結果を正常系→準正常系→異常系の順に表示するようにした。

### 変更詳細

#### プロンプト (`prompts.ts`)
- 「出力フォーマット制約」のTag指示にテスト種別タグの定義を追加：
  - `normal` … 正常系（ハッピーパス、基本動作確認）
  - `semi-normal` … 準正常系（境界値、バリデーション、状態遷移、権限チェック）
  - `abnormal` … 異常系（不正入力、エラーハンドリング、悪用・誤操作、セキュリティ）
- rows の出力順序を `normal → semi-normal → abnormal` にする指示を追加
- 同一種別内では Case 名でグルーピングする指示を追加

#### カバレッジルール (`rules/*.yaml`)
- 3ファイルすべての `recommended_tags` に `normal`, `semi-normal`, `abnormal` を追加

#### バックエンド (`design.ts`)
- `sortRowsByTestType()` 関数を追加。Tag からテスト種別を判定し、normal(0) → semi-normal(1) → abnormal(2) の順にソート
- 同一種別内は Case 名の日本語ロケールでグルーピング
- テスト種別タグが付いていない行は `semi-normal` 相当（中間）にフォールバック
- LLM生成後・ID付与前に適用（LLMが順序を守らなかった場合のセーフティネット）

---

## v2 — 2026-02-10

**ファイル:** `backend/src/lib/llm/prompts.ts` の `SYSTEM_PROMPT`

### 変更概要
`docs/システムプロンプト候補.txt` の追加指針・行動ルールを統合し、IR JSON出力制約との整合を取りつつプロンプト品質を大幅に向上。

### 変更詳細

#### 追加した項目

| 候補の項目 | 反映先 | 内容 |
|---|---|---|
| 追加指針 #1 テストケースの最小単位化 | 「テストケース設計の品質基準 > 最小単位化」 | 1操作→1期待結果の原則、重複排除 |
| 追加指針 #2 必須情報の明示 | 「テストケース設計の品質基準 > Step/Expectedの記述品質」 | API/DB/画面操作の具体的記述、判定可能な期待結果の要求 |
| 追加指針 #6 過去バグパターンの参照 | 「自動推論ルール」内に具体例追加 | SQLi, XSS, 入力長制限超過, ページネーションバグ等。remarksに「過去典型バグ参照」記載を指示 |
| 追加指針 #8 質問リストの補完強化 | 「出力フォーマット制約」suite.assumptionsの指示 | 不明な点を「[質問] ○○は△△という理解で正しいか？」形式にする指示を追加 |
| 追加指針 #10 自動生成結果の品質チェック | 「出力前の自己検証」セクション新設 | 必須フィールド確認、重複検出、正常系偏り検出、remarks空文字検出、assumptions漏れ検出 |
| 行動ルール（候補の「行動ルール」セクション） | 「行動ルール」セクション新設 | 仕様が曖昧でも止まらない、書いてないから作らないは禁止、QA指摘の明示、日本語で簡潔論理的 |
| 候補の「出力構成」セクション1〜4 | 「出力の内部構成指針」セクション新設 | 思考プロセスとIR JSONフィールドの対応関係を明示（assumptions, notes, rowsへのマッピング） |
| 禁止事項の追加 | 「禁止事項」に1項目追加 | 「曖昧な期待結果（正しく動作する等）」を禁止に追加 |

#### 統合しなかった項目（理由）

| 候補の項目 | 理由 |
|---|---|
| 追加指針 #3 自動化可否・労力見積もり | IR JSONスキーマに対応フィールドがない。将来のスキーマ拡張で対応予定 |
| 追加指針 #4 品質保証マトリクスの自動生成 | 単一生成ではなくプロジェクト横断の機能。アプリ側で対応すべき |
| 追加指針 #5 リスクマップの併出力 | suite.notesに品質リスク分析を記載する指示で代替済み |
| 追加指針 #7 CI/CD連携サンプルの同時出力 | IR JSON出力とは異なるフォーマット。別機能として検討 |
| 追加指針 #9 バージョン管理と変更履歴 | アプリのIrVersion機能で対応済み |

#### 構成上の改善

- 「入力に対する基本姿勢」を箇条書きに展開（候補の書式に合わせ可読性向上）
- 「思考原則」のUI以外の考慮点を箇条書きに展開
- 「テストケース設計の品質基準」セクションを新設し、Step/Expected/remarksの記述品質を明文化
- 「出力の内部構成指針」セクションで、候補の「出力構成」セクション1〜4の思考プロセスをIR JSONフィールドに対応付けて指示

---

## v1 — 初版

**ファイル:** `backend/src/lib/ollama.ts`（後に `backend/src/lib/llm/prompts.ts` に移動）

`docs/システムプロンプト候補.txt` をベースに、IR JSON出力制約（JSON Schema準拠、suite/rows構造）に適合するよう編集した初版。
候補の「出力構成」セクション（テキスト形式の6セクション出力）をJSON出力用に変換し、
「出力フォーマット制約」セクションとして再構成。
