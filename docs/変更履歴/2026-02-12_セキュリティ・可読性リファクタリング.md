# 変更履歴（2026-02-12）

## 概要

この変更では、以下の2点を最優先にリファクタリングを実施した。

1. **脆弱性リスクの低減**（入力検証、エラーハンドリング、HTTP呼び出しの堅牢化）
2. **可読性と保守性の向上**（重複排除、責務分離、共通化）

---

## 変更ファイル

### Backend

- `backend/src/server.ts`
- `backend/src/app/settings.ts`
- `backend/src/app/models.ts`
- `backend/src/app/profiles.ts`
- `backend/src/app/ir.ts`
- `backend/src/app/design.ts`
- `backend/src/app/export.ts`
- `backend/src/lib/rules.ts`
- `backend/src/lib/llm/settings.ts`
- `backend/src/lib/llm/registry.ts`
- `backend/src/lib/llm/types.ts`
- `backend/src/lib/llm/providers/openai.ts`
- `backend/src/lib/llm/providers/gemini.ts`
- `backend/src/lib/llm/providers/anthropic.ts`
- `backend/src/lib/llm/providers/ollama.ts`
- `backend/src/lib/http.ts`（新規）
- `backend/src/lib/ir-validation.ts`（新規）
- `backend/src/lib/llm/http-client.ts`（新規）
- `backend/src/lib/llm/model-id.ts`（新規）

### UI

- `ui/lib/api.ts`
- `ui/lib/store.ts`
- `ui/components/layout/left-pane.tsx`
- `ui/components/settings/llm-settings-modal.tsx`
- `ui/components/profile/profile-modal.tsx`

---

## セキュリティ観点の主な改善

### 1) 入力バリデーションの共通化と厳格化

- `backend/src/lib/ir-validation.ts` を追加し、IR構造・文字数・配列上限を一元管理。
- `backend/src/app/ir.ts` / `backend/src/app/export.ts` / `backend/src/app/design.ts` で共通スキーマを利用。
- `backend/src/app/settings.ts` で `openai_base_url` を `http/https` URLとして検証。
- `backend/src/app/profiles.ts` で更新時の空payload拒否、文字数上限、`strict()` 適用。

**効果:** routeごとの検証の揺れを防止し、想定外入力による不具合やDoS的な過大入力リスクを低減。

### 2) パラメータ検証とHTTPエラー統一

- `backend/src/lib/http.ts` を追加。
  - `parsePositiveIntParam`（数値ID検証）
  - `parseUuidParam`（UUID検証）
  - `handleRouteError`（Zod/Prisma/独自エラーの標準レスポンス化）
- `profiles` / `ir` / `settings` / `models` / `design` / `export` に適用。

**効果:** 入力不正の早期検知、エラー応答の一貫化、例外漏れ防止。

### 3) サーバー設定の安全化

- `backend/src/server.ts` で以下を実施。
  - `x-powered-by` 無効化
  - CORSの許可オリジン制御（`CORS_ALLOWED_ORIGINS`）
  - JSON Body上限を `10mb -> 1mb` に縮小
  - JSONパース失敗時の明示的 400 応答
  - `/api` 配下の404統一
  - SIGINT/SIGTERM時の `prisma.$disconnect()`

**効果:** 不要な情報露出の抑制、過大payload耐性向上、運用停止時の安全性向上。

### 4) 外部LLM通信の堅牢化

- `backend/src/lib/llm/http-client.ts` を追加。
  - fetchタイムアウト
  - 通信失敗メッセージの統一
  - エラーボディ読み取りの安全化
- OpenAI/Gemini/Anthropic/Ollama 全プロバイダへ適用。

**効果:** 外部API障害時のハング抑止、調査可能なエラー情報の確保。

### 5) model_id / URL の入力安全性

- `backend/src/lib/llm/model-id.ts` を追加し、`provider:model` を厳格検証。
- `backend/src/lib/llm/settings.ts` でOpenAI Base URLを正規化+検証。
- `ui/lib/api.ts` で path segment を `encodeURIComponent`、`/` 混入を拒否。

**効果:** 不正形式入力による誤動作や想定外ルーティングを抑止。

---

## 可読性・保守性の主な改善

### 1) backendの重複削減

- `design.ts` の「1回目失敗→再試行」ロジックを `generateDesignWithRetry` に集約。
- `profiles.ts` の profileレスポンス変換を `mapProfileToResponse` に集約。
- `ir.ts` の保存処理をトランザクション化し、処理意図を明確化。

### 2) frontendの重複削減

- `ui/components/layout/left-pane.tsx`
  - テスト技法ラベル解決を `resolveTechniqueLabels` に集約。
  - カバレッジ表示定義を `COVERAGE_OPTIONS` 化。
  - カスタム技法追加/削除処理を関数化。
  - `watch("test_techniques")` の重複参照を削減。
- `ui/lib/store.ts`
  - タグ操作を `mergeCaseTags` / `removeCaseTag` / `getCaseTagList` に集約。
  - `moveRow` の境界チェック追加。
- `ui/lib/api.ts`
  - API path組み立て共通化（`apiPath`）
  - request処理のヘッダー制御明確化
  - payload整形処理の明示化

### 3) UI側の誤操作抑止

- `llm-settings-modal.tsx` でOpenAI Base URLの事前検証。
- `profile-modal.tsx` で `name` 空欄時は保存ボタンを無効化。

---

## 「今回はリファクタリング不要」と判断した箇所

以下は意図的に改修対象外とした。

1. **`ui/components/ui/*`（shadcn系UI部品）**
   - 理由: 業務ロジックを持たない共通UI部品であり、今回のセキュリティ/可読性課題の主因ではない。

2. **`backend/src/lib/llm/prompts.ts` のプロンプト本文**
   - 理由: 品質/仕様挙動に直結するドメイン資産のため、可読性目的での文言改変は生成結果回帰リスクが高い。

3. **`rules/*.yaml` のテスト設計ルール内容**
   - 理由: ルールの中身はプロダクト要件。今回は「読み込み安全性（`rules.ts`）」のみ改修し、要件そのものは変更しない。

4. **`ui/out/*` などのビルド成果物**
   - 理由: 生成物でありソース管理対象の本質ではない。ソース修正のみ実施。

---

## 追加メモ（検証結果）

- Backend: `npm run build` 成功（TypeScriptコンパイル通過）。
- UI: `npm run build` は `next` モジュール不足で未実施（依存未配置）。
  - エラー: `Cannot find module ... ui/node_modules/next/dist/bin/next`
  - 対応方針: UI依存を再インストール後に再ビルドを実施する。

